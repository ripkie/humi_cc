#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include "DHT.h"

// ===== OLED SETUP =====
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ===== DHT SETUP =====
#define DHTPIN 32
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

// ===== LOGO BITMAP (128x32) =====
const unsigned char logo_unova[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xf0, 0x01, 0xe0, 0x07, 0xfc, 0x00, 0x03, 0xf8, 0x07, 0x80, 0x03,
    0xc0, 0x7f, 0xc0, 0x00, 0x00, 0xf0, 0x01, 0xe0, 0x1f, 0xff, 0x00, 0x0f,
    0xff, 0x03, 0xc0, 0x07, 0x81, 0xff, 0xf0, 0x00, 0x00, 0xf0, 0x01, 0xe0,
    0x3f, 0x1f, 0x80, 0x3f, 0xff, 0x83, 0xc0, 0x07, 0x83, 0xf1, 0xfc, 0x00,
    0x00, 0xf0, 0x01, 0xe0, 0x7c, 0x07, 0xc0, 0x7c, 0x03, 0xc1, 0xc0, 0x0f,
    0x87, 0xc0, 0x7c, 0x00, 0x00, 0xf0, 0x01, 0xe0, 0x78, 0x03, 0xc0, 0x70,
    0x01, 0xe1, 0xe0, 0x0f, 0x0f, 0x80, 0x1e, 0x00, 0x00, 0xf0, 0x01, 0xe0,
    0xf0, 0x01, 0xe0, 0xf0, 0x00, 0xe1, 0xe0, 0x0f, 0x0f, 0x00, 0x1e, 0x00,
    0x00, 0xf0, 0x01, 0xe0, 0xf0, 0x01, 0xe0, 0xe0, 0x00, 0x40, 0xf0, 0x1e,
    0x0f, 0x00, 0x0f, 0x00, 0x00, 0xf0, 0x01, 0xe0, 0xf0, 0x01, 0xe0, 0xe0,
    0x00, 0x40, 0xf0, 0x1e, 0x1e, 0x00, 0x0f, 0x00, 0x00, 0xf0, 0x01, 0xe0,
    0xf0, 0x01, 0xe1, 0xe0, 0x00, 0xf0, 0x78, 0x3c, 0x1e, 0x00, 0x0f, 0x00,
    0x00, 0xf0, 0x01, 0xe0, 0xf0, 0x01, 0xe0, 0xe0, 0x00, 0xe0, 0x78, 0x3c,
    0x1e, 0x00, 0x0f, 0x00, 0x00, 0xf0, 0x01, 0xe0, 0xf0, 0x01, 0xe0, 0xe0,
    0x00, 0x00, 0x3c, 0x78, 0x0f, 0x00, 0x0f, 0x00, 0x00, 0xf0, 0x01, 0xe0,
    0xf0, 0x01, 0xe0, 0xe0, 0x00, 0xc0, 0x3c, 0x78, 0x0f, 0x00, 0x1f, 0x00,
    0x00, 0x78, 0x03, 0xc0, 0xf0, 0x01, 0xe0, 0x70, 0x01, 0xc0, 0x3c, 0x70,
    0x0f, 0x80, 0x1f, 0x00, 0x00, 0x7c, 0x07, 0xc0, 0xf0, 0x01, 0xe0, 0x7c,
    0x03, 0xc0, 0x1e, 0xf0, 0x07, 0xc0, 0x7f, 0x00, 0x00, 0x3f, 0x1f, 0x80,
    0xf0, 0x01, 0xe0, 0x3f, 0xff, 0x80, 0x1f, 0xf0, 0x03, 0xf1, 0xff, 0x00,
    0x00, 0x1f, 0xff, 0x00, 0xf0, 0x01, 0xe0, 0x0f, 0xff, 0x00, 0x0f, 0xe0,
    0x01, 0xff, 0xff, 0x00, 0x00, 0x07, 0xfc, 0x00, 0xf0, 0x01, 0xe0, 0x03,
    0xf8, 0x00, 0x07, 0xc0, 0x00, 0x7f, 0xcf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

// ===== STATE =====
enum DisplayState
{
  SHOW_WELCOME,
  SHOW_LOGO,
  SHOW_DATA
};
DisplayState currentState = SHOW_WELCOME;

unsigned long stateStartTime;

void setup()
{
  Serial.begin(9600);
  Wire.begin();

  // OLED init
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C))
  {
    for (;;)
      ;
  }

  display.clearDisplay();
  display.display();

  dht.begin();

  // ===== WELCOME SCREEN =====
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);

  // Tengah horizontal & vertikal
  display.setCursor(18, 24);
  display.println("WELCOME");
  display.display();

  stateStartTime = millis();
}

void loop()
{
  // ===== WELCOME 2,5 DETIK =====
  if (currentState == SHOW_WELCOME)
  {
    if (millis() - stateStartTime >= 2500)
    {
      currentState = SHOW_LOGO;
      stateStartTime = millis();

      display.clearDisplay();
      display.drawBitmap(
          0,
          16,
          logo_unova,
          128,
          32,
          SSD1306_WHITE);
      display.display();
    }
    return;
  }

  // ===== LOGO 3 DETIK =====
  if (currentState == SHOW_LOGO)
  {
    if (millis() - stateStartTime >= 3000)
    {
      currentState = SHOW_DATA;
      display.clearDisplay();
      display.display();
    }
    return;
  }

  // ===== BACA SENSOR =====
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature(); // Celsius

  // ===== CEK ERROR SENSOR =====
  if (isnan(humidity) || isnan(temperature))
  {
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 20);
    display.println("DHT22 ERROR");
    display.display();
    delay(2000);
    return;
  }

  // ===== LOGIKA MODE =====
  String mode = "IDLE";
  if (humidity > 65)
    mode = "DEHUMIDIFIER";
  else if (humidity < 45)
    mode = "HUMIDIFIER";

  // ===== TAMPILAN OLED =====
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);

  display.setCursor(0, 0);
  display.println("HUMIDITY CONTROL");

  display.setCursor(0, 14);
  display.print("Temp : ");
  display.print(temperature, 1);
  display.println(" C");

  display.setCursor(0, 26);
  display.print("RH   : ");
  display.print(humidity, 1);
  display.println(" %");

  display.setCursor(0, 40);
  display.print("Mode : ");
  display.println(mode);

  display.display();
  delay(2000);
}
